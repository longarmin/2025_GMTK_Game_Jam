[gd_scene load_steps=19 format=3 uid="uid://3j87k68xo4ug"]

[ext_resource type="Texture2D" uid="uid://d07un6ita4esd" path="res://assets/lucy/idle/idle.png" id="1_2ieo8"]
[ext_resource type="Texture2D" uid="uid://ckdstkswgy7yp" path="res://assets/lucy/idle/blinking.png" id="2_ebec5"]
[ext_resource type="Texture2D" uid="uid://bb43c0s5ktt4e" path="res://assets/lucy/fall.png" id="2_kb6p2"]
[ext_resource type="Texture2D" uid="uid://vcwnftmgqlr4" path="res://assets/lucy/dust_particle.png" id="2_wodsf"]
[ext_resource type="Texture2D" uid="uid://c3i67gf5xtur1" path="res://assets/lucy/idle/crouching.png" id="3_yllr7"]
[ext_resource type="Texture2D" uid="uid://1w6y4aov8x8i" path="res://assets/lucy/idle/looking_right.png" id="4_kb6p2"]
[ext_resource type="Texture2D" uid="uid://cxslh8teup70q" path="res://assets/lucy/idle/looking_front.png" id="5_wodsf"]
[ext_resource type="Texture2D" uid="uid://byi5d5liq08bu" path="res://assets/lucy/run/000.png" id="6_32hag"]
[ext_resource type="Texture2D" uid="uid://cqhwdqlpfm50e" path="res://assets/lucy/run/001.png" id="7_tqiix"]
[ext_resource type="Texture2D" uid="uid://2xur0ruvk44k" path="res://assets/lucy/jump.png" id="7_yllr7"]
[ext_resource type="Texture2D" uid="uid://7hdpmnwe0m7k" path="res://assets/lucy/run/002.png" id="8_e7oew"]
[ext_resource type="Texture2D" uid="uid://c030uv7w2bgs3" path="res://assets/lucy/run/003.png" id="9_c35mf"]
[ext_resource type="Texture2D" uid="uid://dw8wfsxexlcit" path="res://assets/lucy/run/004.png" id="10_65viv"]
[ext_resource type="Texture2D" uid="uid://pk8wb3owg84f" path="res://assets/lucy/run/005.png" id="11_x7c3f"]

[sub_resource type="GDScript" id="GDScript_kb6p2"]
script/source = "extends CharacterBody2D

const MAX_JUMPS := 2

enum State {GROUND, JUMP, FALL, DOUBLE_JUMP}

@export var acceleration:= 700
@export var air_acceleration:=400.0
@export var deceleration:= 1400
@export var max_speed:= 120
@export var max_fall_speed:= 250

@export_category(\"Jump\")
@export_range(10.0, 200.0) var jump_height := 50.0
@export_range(0.1, 1.5) var jump_time_to_peak := 0.37
@export_range(0.1, 1.5) var jump_time_to_descent := 0.2
@export_range(50.0, 200.0) var jump_horizontal_distance := 80

@export_range(5.0, 50.0) var jump_cut_divider := 15.0

@export_category(\"Double Jump\")
@export_range(10.0, 200.0) var double_jump_height := 30.0
@export_range(0.1, 1.5) var double_jump_time_to_peak := 0.3
@export_range(0.1, 1.5) var double_jump_time_to_descent := 0.25

var direction_x := 0.0
var current_state : State = State.GROUND
var current_gravity := 0.0

#state-specific variables:
var jump_count := 0

@onready var animated_sprite : AnimatedSprite2D = %AnimatedSprite2D
@onready var coyote_timer := Timer.new()
@onready var jump_input_buffer_timer := Timer.new()
@onready var dust: GPUParticles2D = %Dust

@onready var jump_speed = calculate_jump_speed(jump_height, jump_time_to_peak)
@onready var jump_gravity := calculate_jump_gravity(jump_height, jump_time_to_peak)
@onready var fall_gravity := calculate_fall_gravity(jump_height, jump_time_to_descent)
@onready var jump_horizontal_speed : float = calculate_jump_horizontal_speed(jump_horizontal_distance, jump_time_to_peak, jump_time_to_descent)

@onready var double_jump_speed = calculate_jump_speed(double_jump_height, double_jump_time_to_peak)
@onready var double_jump_gravity := calculate_jump_gravity(double_jump_height, double_jump_time_to_peak)
@onready var double_jump_fall_gravity := calculate_fall_gravity(double_jump_height, double_jump_time_to_descent)

func _ready() -> void:
	#Debug: Slow game down:
	#Engine.time_scale = 0.5
	_transition_to_state(State.GROUND)
	coyote_timer.wait_time = 0.05
	coyote_timer.one_shot = true
	add_child(coyote_timer)
	jump_input_buffer_timer.wait_time = 0.05
	jump_input_buffer_timer.one_shot = true
	add_child(jump_input_buffer_timer)
	
func _physics_process(delta: float) -> void:
	direction_x = signf(Input.get_axis(\"move_left\",\"move_right\"))
	
	match current_state:
		State.GROUND:
			_physics_process_ground(delta)
		State.JUMP:
			_physics_process_jump(delta)
		State.FALL:
			_physics_process_fall(delta)
		State.DOUBLE_JUMP:
			_physics_process_double_jump(delta)
		
	velocity.y += current_gravity * delta
	velocity.y = minf(velocity.y, max_fall_speed)
	move_and_slide()
	
func calculate_jump_horizontal_speed(distance: float, time_to_peak: float, time_to_descent: float) -> float:
	return distance/(time_to_peak + time_to_descent)

func _physics_process_ground(delta: float) -> void:
	var is_moving := absf(direction_x) > 0.0
	if is_moving:
		velocity.x = clampf(velocity.x + direction_x * acceleration * delta, -max_speed, max_speed)
		animated_sprite.flip_h = 0.0 > direction_x
		animated_sprite.play(\"Run\")
	else:
		velocity.x = move_toward(velocity.x, 0, deceleration*delta)
		animated_sprite.play(\"Idle\")
	
	dust.emitting = absf(direction_x) > 0.0
	
	if not jump_input_buffer_timer.is_stopped():
		_transition_to_state(State.JUMP)
	if Input.is_action_just_pressed(\"jump\"):
		_transition_to_state(State.JUMP)
	elif not is_on_floor():
		_transition_to_state(State.FALL)
		
func _physics_process_jump(delta: float) -> void:
	if direction_x != 0.0:
		velocity.x = clampf(velocity.x + direction_x * air_acceleration * delta, -jump_horizontal_speed, jump_horizontal_speed)
		animated_sprite.flip_h = 0.0 > direction_x
	if Input.is_action_just_released(\"jump\"):
		var jump_cut_speed : float = jump_speed / jump_cut_divider
		if velocity.y < 0.0 and velocity.y < jump_cut_divider:
			velocity.y = jump_cut_speed
	if velocity.y >= 0.0:
		_transition_to_state(State.FALL)
	elif Input.is_action_just_pressed(\"jump\") and jump_count < MAX_JUMPS:
		_transition_to_state(State.DOUBLE_JUMP)
			
func _physics_process_fall(delta: float) -> void:
	velocity.x = clampf(velocity.x + direction_x * acceleration * delta, -jump_horizontal_speed, jump_horizontal_speed)
	animated_sprite.flip_h = 0.0 > direction_x
	
	if Input.is_action_just_pressed(\"jump\"):
		if not coyote_timer.is_stopped():
			_transition_to_state(State.JUMP)
		elif jump_count < MAX_JUMPS:
			_transition_to_state(State.DOUBLE_JUMP)	
		else:
			jump_input_buffer_timer.start()
	if is_on_floor():
		_transition_to_state(State.GROUND)	
	
func _physics_process_double_jump(delta: float) -> void:
	if direction_x != 0.0:
		velocity.x = clampf(velocity.x + direction_x * air_acceleration * delta, -jump_horizontal_speed, jump_horizontal_speed)
		animated_sprite.flip_h = 0.0 > direction_x
	if velocity.y >= 0.0:
		_transition_to_state(State.FALL)
		
func _transition_to_state(new_state: State):
	print(\"Transitioning from \", State.keys()[current_state], \" to \", State.keys()[new_state])
	%Label.text = \"State: \" + State.keys()[new_state]
	var previous_state = current_state
	current_state = new_state
	match previous_state:
		State.FALL:
			coyote_timer.stop()
	match current_state:
		State.GROUND:
			jump_count = 0
			if previous_state == State.FALL:
				play_tween_touch_ground()
		State.JUMP:
			velocity.y = jump_speed
			current_gravity = jump_gravity
			velocity.x = direction_x * jump_horizontal_speed
			animated_sprite.play(\"Jump\")
			jump_count = 1
			play_tween_jump()
			dust.emitting = true
		State.DOUBLE_JUMP:
			velocity.y = double_jump_speed
			current_gravity = double_jump_gravity
			velocity.x = direction_x * jump_horizontal_speed
			animated_sprite.play(\"Jump\")
			jump_count = MAX_JUMPS
			play_tween_jump()
			dust.emitting = true
		State.FALL:
			if jump_count == MAX_JUMPS:
				current_gravity = double_jump_fall_gravity
			else:
				current_gravity = fall_gravity
				
			if previous_state == State.GROUND:
				coyote_timer.start()
				
			animated_sprite.play(\"Fall\")
			
func calculate_jump_speed(height:float, time_to_peak:float)->float:
	return ((-2.0*height)/time_to_peak)
	
func calculate_jump_gravity(height:float, time_to_peak:float)->float:
	return (2*height/pow(time_to_peak,2.0))
	
func calculate_fall_gravity(height:float, time_to_descent:float)->float:
	return (2 * height/pow(time_to_descent,2.0))
	
func play_tween_jump() -> void:
	var tween := create_tween()
	tween.tween_property(animated_sprite, \"scale\", Vector2(1.15, 0.86), 0.1).set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_BACK)
	tween.tween_property(animated_sprite, \"scale\", Vector2(0.86, 1.15), 0.1).set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_BACK)
	tween.tween_property(animated_sprite, \"scale\", Vector2.ONE, 0.15)

func play_tween_touch_ground() -> void:
	var tween := create_tween()
	tween.tween_property(animated_sprite, \"scale\", Vector2(1.1, 0.9), 0.1).set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_BACK)
	tween.tween_property(animated_sprite, \"scale\", Vector2(0.9, 1.1), 0.1).set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_BACK)
	tween.tween_property(animated_sprite, \"scale\", Vector2.ONE, 0.15)
	animated_sprite.rotation_degrees = 0.0
"

[sub_resource type="SpriteFrames" id="SpriteFrames_7qyjy"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": ExtResource("2_kb6p2")
}],
"loop": true,
"name": &"Fall",
"speed": 5.0
}, {
"frames": [{
"duration": 20.0,
"texture": ExtResource("1_2ieo8")
}, {
"duration": 1.0,
"texture": ExtResource("2_ebec5")
}, {
"duration": 2.0,
"texture": ExtResource("1_2ieo8")
}, {
"duration": 1.0,
"texture": ExtResource("2_ebec5")
}, {
"duration": 0.7,
"texture": ExtResource("3_yllr7")
}, {
"duration": 5.0,
"texture": ExtResource("4_kb6p2")
}, {
"duration": 0.7,
"texture": ExtResource("3_yllr7")
}, {
"duration": 5.0,
"texture": ExtResource("5_wodsf")
}, {
"duration": 0.7,
"texture": ExtResource("3_yllr7")
}],
"loop": true,
"name": &"Idle",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("7_yllr7")
}],
"loop": true,
"name": &"Jump",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("6_32hag")
}, {
"duration": 1.0,
"texture": ExtResource("7_tqiix")
}, {
"duration": 1.0,
"texture": ExtResource("8_e7oew")
}, {
"duration": 1.0,
"texture": ExtResource("9_c35mf")
}, {
"duration": 1.0,
"texture": ExtResource("10_65viv")
}, {
"duration": 1.0,
"texture": ExtResource("11_x7c3f")
}],
"loop": true,
"name": &"Run",
"speed": 5.0
}]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_wodsf"]
size = Vector2(8, 14)

[sub_resource type="ParticleProcessMaterial" id="ParticleProcessMaterial_kb6p2"]
particle_flag_disable_z = true
gravity = Vector3(0, -8, 0)

[node name="Player" type="CharacterBody2D"]
collision_mask = 2
script = SubResource("GDScript_kb6p2")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
unique_name_in_owner = true
sprite_frames = SubResource("SpriteFrames_7qyjy")
animation = &"Idle"
frame_progress = 0.142575

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(0, 4)
shape = SubResource("RectangleShape2D_wodsf")

[node name="Dust" type="GPUParticles2D" parent="."]
unique_name_in_owner = true
emitting = false
texture = ExtResource("2_wodsf")
process_material = SubResource("ParticleProcessMaterial_kb6p2")

[node name="Label" type="Label" parent="."]
unique_name_in_owner = true
offset_left = -20.0
offset_top = -28.0
offset_right = 20.0
offset_bottom = -5.0
